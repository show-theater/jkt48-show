<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JKT48 Show Theater</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f5f5f5;color:#333;min-height:100vh;padding-bottom:60px;transition:background 0.3s,color 0.3s}
body.dark{background:#0a0e1a;color:#e5e7eb}
header{background:#e60012;text-align:center;padding:20px 60px 20px 20px;font-size:24px;font-weight:bold;color:#fff;position:relative}
.theme-toggle{position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);border:none;color:#fff;width:40px;height:40px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:8px}
.theme-toggle:hover{background:rgba(255,255,255,0.3)}
.theme-toggle svg{width:100%;height:100%;transition:transform 0.3s}
.theme-toggle:hover svg{transform:rotate(20deg)}
.top{padding:15px 20px;background:#fff;border-bottom:1px solid #ddd;text-align:center;transition:background 0.3s,border-color 0.3s}
body.dark .top{background:#1b1f3a;border-bottom:1px solid #2d3548}
.search-box{display:inline-block;width:100%;max-width:400px;position:relative}
.search-box input{width:100%;padding:12px 20px;border-radius:25px;border:2px solid #f59e0b;background:#fff;font-size:14px;outline:none;color:#333;transition:all 0.3s}
.search-box input:focus{border-color:#f97316}
body.dark .search-box input{background:#0a0e1a;color:#e5e7eb;border-color:#f59e0b}

.last-update{text-align:center;padding:8px;font-size:11px;color:#9ca3af;background:#fff;transition:background 0.3s;display:flex;align-items:center;justify-content:center;gap:6px}
body.dark .last-update{background:#0a0e1a;color:#6b7280}
.last-update .spinner{width:12px;height:12px;border-width:2px}

.filters{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:15px 20px;background:#fff;border-bottom:1px solid #ddd;transition:background 0.3s,border-color 0.3s}
body.dark .filters{background:#1b1f3a;border-bottom:1px solid #2d3548}
.filter{padding:8px 16px;font-size:13px;border-radius:20px;border:2px solid transparent;cursor:pointer;font-weight:bold;background:#f0f0f0;color:#333;transition:all 0.3s}
.filter.active{border-color:#e60012}
.filter.all{background:#e60012;color:#fff}
.filter.all.active{border-color:#c00010}
body.dark .filter{background:#1f2937;color:#e5e7eb}
body.dark .filter.all{background:#c00010;color:#fff}
body.dark .filter.gen-filter[data-gen="3"]{background:#9d174d;color:#fff}
body.dark .filter.gen-filter[data-gen="6"]{background:#15803d;color:#fff}
body.dark .filter.gen-filter[data-gen="7"]{background:#14532d;color:#fff}
body.dark .filter.gen-filter[data-gen="8"]{background:#1e3a8a;color:#fff}
body.dark .filter.gen-filter[data-gen="9"]{background:#0e7490;color:#fff}
body.dark .filter.gen-filter[data-gen="10"]{background:#0369a1;color:#fff}
body.dark .filter.gen-filter[data-gen="11"]{background:#c2410c;color:#fff}
body.dark .filter.gen-filter[data-gen="12"]{background:#a16207;color:#fff}
body.dark .filter.gen-filter[data-gen="13"]{background:#854d0e;color:#fff}
body.dark .filter.gen-filter[data-gen="14"]{background:#a855f7;color:#fff}

.stats{text-align:center;padding:8px;font-size:12px;color:#9ca3af;background:#fff;transition:background 0.3s}
body.dark .stats{background:#0a0e1a;color:#6b7280}

.container{padding:20px;display:grid;grid-template-columns:repeat(4,1fr);gap:15px;max-width:900px;margin:0 auto}
@media (max-width:600px){.container{grid-template-columns:repeat(4,1fr);gap:10px;padding:15px}}

.card{background:#fff;border-radius:12px;padding:0;text-align:center;cursor:pointer;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:all 0.3s}
.card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.15)}
body.dark .card{background:#1b1f3a;box-shadow:0 2px 8px rgba(0,0,0,0.4)}
body.dark .card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.6)}

.avatar{width:100%;aspect-ratio:3/4;object-fit:cover;background:#f0f0f0;display:block;transition:all 0.3s}
body.dark .avatar{background:#0a0e1a}

.card-footer{padding:8px 6px;background:var(--gen-color)}
.gen-badge{display:inline-block;background:rgba(0,0,0,0.2);color:#fff;font-size:8px;font-weight:bold;padding:2px 6px;border-radius:8px;margin-bottom:4px}

.name{font-weight:bold;font-size:12px;color:#fff;margin-bottom:3px}
.show{font-size:10px;color:rgba(255,255,255,0.9);margin-bottom:4px}
.bar{height:4px;background:rgba(0,0,0,0.2);border-radius:2px;overflow:hidden}
.bar span{display:block;height:100%;background:#fff}
body.dark .bar{background:rgba(255,255,255,0.1)}
body.dark .bar span{background:rgba(255,255,255,0.8)}

.msg{grid-column:1/-1;text-align:center;padding:40px 20px;color:#9ca3af}
body.dark .msg{color:#6b7280}

.loading{display:flex;align-items:center;justify-content:center;gap:8px;grid-column:1/-1;padding:60px 20px}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{display:inline-block;width:32px;height:32px;border:3px solid rgba(0,0,0,0.1);border-top-color:#f59e0b;border-radius:50%;animation:spin 0.8s linear infinite}
body.dark .spinner{border-color:rgba(255,255,255,0.1);border-top-color:#f59e0b}
</style>
</head>
<body>

<header>
  JKT48 SHOW THEATER
  <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
      <path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>
    </svg>
  </button>
</header>

<div class="top">
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Cari member..." oninput="searchMember()">
  </div>
</div>

<div class="last-update" id="lastUpdate">
  <div class="spinner"></div>
  <span>Loading...</span>
</div>

<div class="filters">
  <button class="filter all active" onclick="filterGen('all')">ALL</button>
  <button class="filter gen-filter" data-gen="3" onclick="filterGen(3)" style="background:#ec4899;color:#fff">Gen 3</button>
  <button class="filter gen-filter" data-gen="6" onclick="filterGen(6)" style="background:#22c55e;color:#fff">Gen 6</button>
  <button class="filter gen-filter" data-gen="7" onclick="filterGen(7)" style="background:#15803d;color:#fff">Gen 7</button>
  <button class="filter gen-filter" data-gen="8" onclick="filterGen(8)" style="background:#1e40af;color:#fff">Gen 8</button>
  <button class="filter gen-filter" data-gen="9" onclick="filterGen(9)" style="background:#06b6d4;color:#fff">Gen 9</button>
  <button class="filter gen-filter" data-gen="10" onclick="filterGen(10)" style="background:#38bdf8;color:#fff">Gen 10</button>
  <button class="filter gen-filter" data-gen="11" onclick="filterGen(11)" style="background:#f97316;color:#fff">Gen 11</button>
  <button class="filter gen-filter" data-gen="12" onclick="filterGen(12)" style="background:#fde68a;color:#000">Gen 12</button>
  <button class="filter gen-filter" data-gen="13" onclick="filterGen(13)" style="background:#facc15;color:#000">Gen 13</button>
  <button class="filter gen-filter" data-gen="14" onclick="filterGen(14)" style="background:#f3c6ff;color:#000">Gen 14</button>
</div>

<div class="stats" id="stats"></div>

<div class="container" id="list">
  <div class="loading">
    <div class="spinner"></div>
    <span>Loading data...</span>
  </div>
</div>

<script>
const SUPABASE_URL = "https://pprxfopqkvpeajeoxzig.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwcnhmb3Bxa3ZwZWFqZW94emlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTI4MTIsImV4cCI6MjA4MTgyODgxMn0.iXRO_dAHhtVHRLqGTresG_63RD2zIaopNXtXYNfthdg";

const GEN_COLORS = {
  3: '#ec4899', 6: '#22c55e', 7: '#15803d', 8: '#1e40af',
  9: '#06b6d4', 10: '#38bdf8', 11: '#f97316', 12: '#fde68a', 
  13: '#facc15', 14: '#f3c6ff'
};

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let members = [];
let currentGen = 'all';
let searchQuery = '';

// Dark mode functionality
function toggleTheme() {
  const body = document.body;
  const icon = document.getElementById('themeIcon');
  body.classList.toggle('dark');
  
  if (body.classList.contains('dark')) {
    icon.innerHTML = '<path d="M12,17a5,5,0,1,1,5-5A5,5,0,0,1,12,17Zm0-8a3,3,0,1,0,3,3A3,3,0,0,0,12,9Zm0-4a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41L6.34,5A1,1,0,0,0,4.93,6.34ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm.64,5.66a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71a1,1,0,0,0-1.41-1.41ZM12,19a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19Zm6.36-2.34a1,1,0,0,0-1.41,1.41l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-3.64-3.95a1,1,0,0,0,.7.29,1,1,0,0,0,.71-1.7l-.71-.71a1,1,0,0,0-1.41,1.41Z"/>';
    localStorage.setItem('jkt48_theme', 'dark');
  } else {
    icon.innerHTML = '<path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>';
    localStorage.setItem('jkt48_theme', 'light');
  }
}

// Load saved theme immediately
(function() {
  const savedTheme = localStorage.getItem('jkt48_theme');
  if (savedTheme === 'dark') {
    document.documentElement.classList.add('dark');
    if (document.body) document.body.classList.add('dark');
  }
})();

async function loadData() {
  try {
    const { data, error } = await db
      .from('members')
      .select('*')
      .order('show', { ascending: false });

    if (error) throw error;

    members = data || [];
    
    const searchInput = document.getElementById('searchInput');
    if (searchInput && searchQuery) {
      searchInput.value = searchQuery;
    }
    
    if (members.length === 0) {
      document.getElementById('list').innerHTML = '<div class="msg">Tidak ada data member</div>';
      document.getElementById('lastUpdate').innerHTML = 'Tidak ada data';
    } else {
      updateLastUpdate();
      renderMembers();
      updateStats();
    }
    
  } catch (err) {
    console.error('Error:', err);
    document.getElementById('list').innerHTML = `<div class="msg" style="color:#ef4444">Error: ${err.message}</div>`;
    document.getElementById('lastUpdate').innerHTML = 'Error loading data';
  }
}

function updateLastUpdate() {
  if (members.length === 0) return;
  
  const latestUpdate = members.reduce((latest, member) => {
    const memberUpdate = member.updated_at ? new Date(member.updated_at) : new Date(0);
    return memberUpdate > latest ? memberUpdate : latest;
  }, new Date(0));
  
  const options = { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
  const formatted = latestUpdate.toLocaleDateString('id-ID', options);
  document.getElementById('lastUpdate').innerHTML = `Terakhir update: ${formatted}`;
}

function renderMembers() {
  const list = document.getElementById('list');
  const searchInput = document.getElementById('searchInput');
  
  searchQuery = searchInput ? searchInput.value.trim() : searchQuery;
  
  let filtered = members.filter(m => {
    const matchGen = currentGen === 'all' || m.gen === currentGen;
    const matchSearch = !searchQuery || m.name.toLowerCase().includes(searchQuery.toLowerCase());
    return matchGen && matchSearch;
  });
  
  if (filtered.length === 0) {
    if (searchQuery) {
      list.innerHTML = `<div class="msg">Tidak ada member dengan nama "${searchQuery}"</div>`;
    } else if (currentGen !== 'all') {
      list.innerHTML = `<div class="msg">Member Generasi ${currentGen} masih belum tersedia</div>`;
    } else {
      list.innerHTML = '<div class="msg">Tidak ada data member</div>';
    }
    return;
  }
  
  list.innerHTML = '';
  const sorted = filtered.sort((a, b) => b.show - a.show);
  
  sorted.forEach(m => {
    const percent = Math.min(100, (m.show / 1000) * 100);
    const color = GEN_COLORS[m.gen] || '#6366f1';
    
    const card = document.createElement('div');
    card.className = 'card';
    card.style.setProperty('--gen-color', color);
    
    card.addEventListener('click', function() {
      const searchInput = document.getElementById('searchInput');
      if (searchInput && searchInput.value) {
        sessionStorage.setItem('jkt48_search_query', searchInput.value);
      }
      sessionStorage.setItem('jkt48_scroll_position', window.scrollY);
      window.location.href = `detail.html?member=${encodeURIComponent(m.name)}`;
    });
    
    card.innerHTML = `
      <img class="avatar" src="img/${m.name.toLowerCase()}.jpg" onerror="this.style.display='none'" alt="${m.name}">
      <div class="card-footer">
        <div class="gen-badge">Gen ${m.gen}</div>
        <div class="name">${m.name}</div>
        <div class="show">${m.show} show</div>
        <div class="bar"><span style="width:${percent}%"></span></div>
      </div>
    `;
    
    list.appendChild(card);
  });
}

function updateStats() {
  const stats = document.getElementById('stats');
  let filtered = members.filter(m => {
    const matchGen = currentGen === 'all' || m.gen === currentGen;
    const matchSearch = !searchQuery || m.name.toLowerCase().includes(searchQuery.toLowerCase());
    return matchGen && matchSearch;
  });
  
  const total = filtered.reduce((sum, m) => sum + m.show, 0);
  stats.innerHTML = `${filtered.length} members â€¢ ${total.toLocaleString()} total shows`;
}

function searchMember() {
  searchQuery = document.getElementById('searchInput').value;
  sessionStorage.setItem('jkt48_search_query', searchQuery);
  renderMembers();
  updateStats();
}

function filterGen(gen) {
  currentGen = gen;
  document.querySelectorAll('.filter').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  renderMembers();
  updateStats();
}

window.addEventListener('DOMContentLoaded', () => {
  const savedTheme = localStorage.getItem('jkt48_theme');
  const icon = document.getElementById('themeIcon');
  
  if (savedTheme === 'dark') {
    document.body.classList.add('dark');
    if (icon) {
      icon.innerHTML = '<path d="M12,17a5,5,0,1,1,5-5A5,5,0,0,1,12,17Zm0-8a3,3,0,1,0,3,3A3,3,0,0,0,12,9Zm0-4a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41L6.34,5A1,1,0,0,0,4.93,6.34ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm.64,5.66a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71a1,1,0,0,0-1.41-1.41ZM12,19a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19Zm6.36-2.34a1,1,0,0,0-1.41,1.41l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-3.64-3.95a1,1,0,0,0,.7.29,1,1,0,0,0,.71-1.7l-.71-.71a1,1,0,0,0-1.41,1.41Z"/>';
    }
  }
  
  const savedScrollPos = sessionStorage.getItem('jkt48_scroll_position');
  if (savedScrollPos) {
    setTimeout(() => {
      window.scrollTo(0, parseInt(savedScrollPos));
      sessionStorage.removeItem('jkt48_scroll_position');
    }, 100);
  }
});

loadData();
</script>
</body>
</html>