<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JKT48 Show Theater</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:linear-gradient(135deg,#0f1220,#1a1f3c);color:#fff;min-height:100vh;padding-bottom:80px;overflow-x:hidden}
header{text-align:center;padding:20px;font-size:28px;font-weight:bold;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
.top{display:flex;justify-content:center;align-items:center;padding:0 20px 10px}
.search-box{width:100%;max-width:400px;position:relative}
.search-box input{width:100%;padding:10px 35px 10px 12px;border-radius:20px;border:2px solid #374151;background:#1f2937;color:#fff;font-size:14px;outline:none;transition:all 0.2s}
.search-box input:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.1)}
.search-box::after{content:'üîç';position:absolute;right:12px;top:50%;transform:translateY(-50%);pointer-events:none;opacity:0.6}

.last-update{text-align:center;padding:5px 20px;font-size:11px;color:#6b7280;font-weight:500}

.filters{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:0 20px 20px}
.filter{padding:10px 18px;font-size:13px;border-radius:20px;transition:all 0.2s;border:none;cursor:pointer;font-weight:bold}
.filter:hover{transform:scale(1.05)}
.filter.active{box-shadow:0 4px 12px rgba(0,0,0,0.4);transform:scale(1.1)}
.filter.all{background:#6366f1;color:#fff}
.filter.all.active{background:#4f46e5}

.container{padding:20px;display:grid;grid-template-columns:repeat(10,1fr);gap:12px;max-width:1400px;margin:0 auto;padding-bottom:60px;overflow-x:hidden}
@media (max-width:1200px){.container{grid-template-columns:repeat(8,1fr)}}
@media (max-width:900px){.container{grid-template-columns:repeat(6,1fr)}}
@media (max-width:600px){.container{grid-template-columns:repeat(5,1fr)}}
@media (max-width:480px){.container{grid-template-columns:repeat(4,1fr)}}

.card{background:#1b1f3a;border-radius:12px;padding:12px 8px 8px 8px;text-align:center;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.2);position:relative;overflow:hidden;cursor:pointer}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--color)}
.card:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 8px 24px rgba(0,0,0,0.4);border:2px solid var(--color)}
.card:hover .avatar{border-width:3px;box-shadow:0 0 20px var(--color)}
.card:hover .bar span{box-shadow:0 0 12px var(--color)}

.avatar{width:100%;aspect-ratio:1;border-radius:50%;border:2px solid var(--color);object-fit:cover;background:linear-gradient(135deg,#374151,#1f2937);box-shadow:0 4px 8px rgba(0,0,0,0.2);transition:all 0.3s}
.gen-badge{position:absolute;top:6px;right:6px;background:var(--color);color:#fff;font-size:10px;font-weight:bold;padding:3px 8px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.3);z-index:10}

.achievement-badge{position:absolute;top:6px;left:6px;font-size:14px;z-index:10;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));display:none}
.card.top-member .achievement-badge{display:block}

.name{margin-top:10px;font-weight:bold;font-size:13px;color:#fff}
.show{font-size:12px;color:#9ca3af;margin-top:4px;font-weight:600}
.bar{margin-top:10px;height:8px;background:#374151;border-radius:8px;overflow:hidden}
.bar span{display:block;height:100%;background:var(--color);transition:all 0.5s cubic-bezier(0.4,0,0.2,1);box-shadow:0 0 8px var(--color)}

.msg{grid-column:1/-1;text-align:center;padding:60px 20px;font-size:16px;color:#9ca3af}

.stats{text-align:center;padding:10px 20px;font-size:13px;color:#9ca3af;font-weight:600}

@keyframes spin{to{transform:rotate(360deg)}}
.spinner{display:inline-block;width:24px;height:24px;border:3px solid rgba(255,255,255,0.1);border-top-color:#9ca3af;border-radius:50%;animation:spin 0.8s linear infinite;margin-right:8px;vertical-align:middle}
.loading-container{display:flex;align-items:center;justify-content:center;gap:8px}

@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.card{animation:slideUp 0.4s ease-out backwards}
.card:nth-child(1){animation-delay:0.05s}
.card:nth-child(2){animation-delay:0.1s}
.card:nth-child(3){animation-delay:0.15s}
.card:nth-child(4){animation-delay:0.2s}
.card:nth-child(5){animation-delay:0.25s}
</style>
</head>
<body>

<header>üî• JKT48 SHOW THEATER</header>

<div class="top">
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Cari member..." oninput="searchMember()">
  </div>
</div>

<div class="last-update" id="lastUpdate"><div class="spinner"></div>Loading...</div>

<div class="filters">
  <button class="filter all active" onclick="filterGen('all')">ALL</button>
  <button class="filter" onclick="filterGen(3)" style="background:#ec4899">Gen 3</button>
  <button class="filter" onclick="filterGen(6)" style="background:#22c55e">Gen 6</button>
  <button class="filter" onclick="filterGen(7)" style="background:#15803d">Gen 7</button>
  <button class="filter" onclick="filterGen(8)" style="background:#1e40af">Gen 8</button>
  <button class="filter" onclick="filterGen(9)" style="background:#06b6d4">Gen 9</button>
  <button class="filter" onclick="filterGen(10)" style="background:#38bdf8">Gen 10</button>
  <button class="filter" onclick="filterGen(11)" style="background:#f97316">Gen 11</button>
  <button class="filter" onclick="filterGen(12)" style="background:#fde68a;color:#000">Gen 12</button>
  <button class="filter" onclick="filterGen(13)" style="background:#facc15;color:#000">Gen 13</button>
  <button class="filter" onclick="filterGen(14)" style="background:#f3c6ff;">Gen 14</button>
</div>

<div class="stats" id="stats"></div>

<div class="container" id="list">
  <div class="msg loading-container"><div class="spinner"></div>Loading data...</div>
</div>

<script>
const SUPABASE_URL = "https://pprxfopqkvpeajeoxzig.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwcnhmb3Bxa3ZwZWFqZW94emlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTI4MTIsImV4cCI6MjA4MTgyODgxMn0.iXRO_dAHhtVHRLqGTresG_63RD2zIaopNXtXYNfthdg";

const GEN_COLORS = {
  3: '#ec4899', 6: '#22c55e', 7: '#15803d', 8: '#1e40af',
  9: '#06b6d4', 10: '#38bdf8', 11: '#f97316', 12: '#fde68a', 
  13: '#facc15', 14: '#f3c6ff'
};

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let members = [];
let currentGen = 'all';
let searchQuery = '';

async function loadData() {
  try {
    const { data, error } = await db
      .from('members')
      .select('*')
      .order('show', { ascending: false });

    if (error) throw error;

    members = data || [];
    
    const savedGen = sessionStorage.getItem('currentGen');
    const savedSearch = sessionStorage.getItem('searchQuery');
    
    if (savedGen) {
      currentGen = savedGen === 'all' ? 'all' : parseInt(savedGen);
      document.querySelectorAll('.filter').forEach(btn => {
        btn.classList.remove('active');
        if ((savedGen === 'all' && btn.classList.contains('all')) || 
            (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`(${savedGen})`))) {
          btn.classList.add('active');
        }
      });
    }
    
    if (savedSearch) {
      searchQuery = savedSearch;
      document.getElementById('searchInput').value = savedSearch;
    }
    
    if (members.length === 0) {
      document.getElementById('list').innerHTML = '<div class="msg">Tidak ada data member</div>';
      document.getElementById('lastUpdate').innerHTML = 'Tidak ada data';
    } else {
      updateLastUpdate();
      renderMembers();
      updateStats();
    }
    
  } catch (err) {
    console.error('Error:', err);
    document.getElementById('list').innerHTML = `<div class="msg" style="color:#ef4444">Error: ${err.message}</div>`;
    document.getElementById('lastUpdate').innerHTML = 'Error loading data';
  }
}

function updateLastUpdate() {
  if (members.length === 0) return;
  
  // Cari updated_at terbaru dari semua member
  const latestUpdate = members.reduce((latest, member) => {
    const memberUpdate = member.updated_at ? new Date(member.updated_at) : new Date(0);
    return memberUpdate > latest ? memberUpdate : latest;
  }, new Date(0));
  
  // Format tanggal
  const options = { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
  const formatted = latestUpdate.toLocaleDateString('id-ID', options);
  document.getElementById('lastUpdate').innerHTML = `Terakhir update: ${formatted}`;
}

function renderMembers() {
  const list = document.getElementById('list');
  let filtered = members.filter(m => {
    const matchGen = currentGen === 'all' || m.gen === currentGen;
    const matchSearch = !searchQuery || m.name.toLowerCase().includes(searchQuery.toLowerCase());
    return matchGen && matchSearch;
  });
  
  if (filtered.length === 0) {
    if (currentGen !== 'all' && !searchQuery) {
      list.innerHTML = `<div class="msg"> Member Generasi ${currentGen} masih belum tersedia<br><small style="color:#6b7280;margin-top:8px;display:block">Segera tersedia mohon tunggu</small></div>`;
    } else {
      list.innerHTML = '<div class="msg">Tidak ada data member</div>';
    }
    return;
  }
  
  list.innerHTML = '';
  const sorted = filtered.sort((a, b) => b.show - a.show);
  
  sorted.forEach((m, idx) => {
    const percent = Math.min(100, (m.show / 1000) * 100);
    const color = GEN_COLORS[m.gen] || '#6366f1';
    
    const card = document.createElement('div');
    card.className = 'card';
    if (idx < 3) card.classList.add('top-member');
    card.style.setProperty('--color', color);
    
    card.addEventListener('click', function() {
      window.location.href = `detail.html?member=${encodeURIComponent(m.name)}`;
    });
    
    let badge = '';
    if (idx === 0) badge = 'üëë';
    else if (idx === 1) badge = 'ü•à';
    else if (idx === 2) badge = 'ü•â';
    
    card.innerHTML = `
      ${badge ? `<div class="achievement-badge">${badge}</div>` : ''}
      <div class="gen-badge">G${m.gen}</div>
      <img class="avatar" src="img/${m.name.toLowerCase()}.jpg" onerror="this.style.display='none'" alt="${m.name}">
      <div class="name">${m.name}</div>
      <div class="show">${m.show} show</div>
      <div class="bar"><span style="width:${percent}%"></span></div>
    `;
    
    list.appendChild(card);
  });
}

function updateStats() {
  const stats = document.getElementById('stats');
  let filtered = members.filter(m => {
    const matchGen = currentGen === 'all' || m.gen === currentGen;
    const matchSearch = !searchQuery || m.name.toLowerCase().includes(searchQuery.toLowerCase());
    return matchGen && matchSearch;
  });
  
  const total = filtered.reduce((sum, m) => sum + m.show, 0);
  stats.innerHTML = ` ${filtered.length} members ‚Ä¢ ${total.toLocaleString()} total shows`;
}

function searchMember() {
  searchQuery = document.getElementById('searchInput').value;
  sessionStorage.setItem('searchQuery', searchQuery);
  renderMembers();
  updateStats();
}

function filterGen(gen) {
  currentGen = gen;
  sessionStorage.setItem('currentGen', gen);
  document.querySelectorAll('.filter').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  renderMembers();
  updateStats();
}

db.channel('members-changes')
  .on('postgres_changes', 
    { event: 'UPDATE', schema: 'public', table: 'members' },
    (payload) => {
      console.log('Realtime update:', payload.new.name);
      const idx = members.findIndex(m => m.id === payload.new.id);
      if (idx !== -1) {
        members[idx] = payload.new;
        updateLastUpdate();
        renderMembers();
        updateStats();
      }
    }
  )
  .subscribe();

window.addEventListener('beforeunload', () => {
  sessionStorage.setItem('scrollPos', window.scrollY);
});

window.addEventListener('load', () => {
  const savedPos = sessionStorage.getItem('scrollPos');
  if (savedPos) {
    window.scrollTo(0, parseInt(savedPos));
  }
});

console.log('JKT48 Show Theater - User View');
loadData();
</script>
</body>
</html>